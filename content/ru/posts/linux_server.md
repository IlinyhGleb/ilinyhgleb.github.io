+++
date = '2025-12-21T08:00:00+05:00'
draft = true
title = 'Первоначальная настройка linux-сервера'
math = true
tags = ["linux", "ssh", "ubuntu", "putty"]
categories = ['Разработка проектов']
+++

<!--more-->


### Настройка сервера


# **1. Создать нового пользователя**

```bash
sudo adduser username
```

* `username` — имя нового пользователя
* система попросит задать пароль и, опционально, дополнительные данные


# **2. Добавить пользователя в группу sudo**

```bash
sudo usermod -aG sudo username
```

* позволяет использовать `sudo` для выполнения команд с повышенными привилегиями
* важно: мы потом ограничим sudo через конфиг, чтобы права были только для нужных команд

---

# **3. Ограничить sudo до необходимых команд**

1. Редактируем файл через `visudo`:

```bash
sudo visudo
```

2. Добавляем в конец (пример для пользователя `username`):

```
username ALL=(ALL) NOPASSWD: /usr/bin/apt, /usr/bin/systemctl, /usr/bin/docker
```

* Этот пример даёт возможность использовать sudo **только для**:

  * установки пакетов (`apt`)
  * управления службами (`systemctl`)
  * работы с Docker (`docker`)

⚠️ Все остальные команды с sudo будут запрещены.

---

# **4. Добавить пользователя в группу docker**

```bash
sudo usermod -aG docker username
```

* после этого пользователь сможет запускать команды Docker без sudo

---

# **5. Проверить группы пользователя**

```bash
groups username
```

* Должно быть что-то вроде:

```
username : username sudo docker
```

---

# **6. Выйти и войти под новым пользователем**

```bash
su - username
```

или переподключиться по SSH

* теперь пользователь может:

  * управлять Docker
  * использовать sudo только для разрешённых команд
  * выполнять обычные действия без полного root-доступа

---

Если хочешь, я могу сделать **ещё более короткую «для отчёта» версию инструкции**, чтобы она была максимально лаконичной и понятной.






# **Краткая инструкция по настройке SSH-порта 2222, включению UFW и закрытию лишних портов (пример: порт 25)**

---

## **1. Разрешить новый SSH-порт 2222 (до включения UFW)**

Чтобы не потерять доступ:

```bash
sudo ufw allow 2222/tcp
```

---

## **2. Включить UFW**

```bash
sudo ufw enable
```

Проверить:

```bash
sudo ufw status
```

---

## **3. (Опционально) Закрыть старый SSH-порт 22, если он не нужен**

```bash
sudo ufw delete allow 22/tcp 2>/dev/null
```
команда может вывести ошибку 
```
Could not delete non-existent rule
Could not delete non-existent rule (v6)
```
если такого правила не было. Это нормально.
```bash
sudo ufw deny 22/tcp
```

Для проверки можно использовать команду
```bash
sudo ufw status
```
Результат должен быть такой:
```
Status: active

To                         Action      From
--                         ------      ----
2222/tcp                   ALLOW       Anywhere                  
25/tcp                     DENY        Anywhere                  
22/tcp                     DENY        Anywhere                  
2222/tcp (v6)              ALLOW       Anywhere (v6)             
25/tcp (v6)                DENY        Anywhere (v6)             
22/tcp (v6)                DENY        Anywhere (v6)   
```


---

## **4. Посмотреть открытые порты в системе**

```bash
ss -tuln
```

---

## **5. Узнать, какой процесс слушает порт 25**

```bash
sudo ss -tulnp | grep :25
```

Пример вывода:

```
users:(("master",pid=458))  → Postfix
```

---

## **6. Остановить службу, открывающую порт 25**

Для Postfix:

```bash
sudo systemctl stop postfix
```

---

## **7. Отключить автозапуск службы**

```bash
sudo systemctl disable postfix
```

---

## **8. Закрыть порт 25 в UFW**

```bash
sudo ufw deny 25/tcp
```

---

## **9. Проверить, что порт закрыт**

```bash
ss -tuln | grep :25
```

Если нет вывода — порт закрыт.








### Инструкция: Настройка SSH-подключения через PuTTY и PuTTYgen с ключом Ed25519


#### **Шаг 1: Создание ключа в PuTTYgen**

1. Откройте **PuTTYgen**.
2. В выпадающем списке выберите: **Ed25519**.
3. Нажмите **Generate** и подвигайте мышкой в окне для генерации случайных данных.
4. В поле **Key passphrase** введите надёжный пароль — **обязательно**.
5. Подтвердите пароль в поле **Confirm passphrase**.
6. Нажмите **Save private key**.
7. Перейдите в папку:  
   `C:\Users\ВашеИмя\.ssh\`  
   → если её нет, создайте вручную.
8. Создайте **подпапку** для сервера, например: `C:\Users\ВашеИмя\.ssh\server-prod\`.
9. Сохраните приватный ключ с именем, например: `id_ed25519.ppk`.
10. Скопируйте содержимое поля **Public key for pasting into OpenSSH authorized_keys file** (начинается с `ssh-ed25519`).
11. Вставьте этот текст на сервер в файл:  
    `~/.ssh/authorized_keys`  
    → если папки или файла нет — создайте.

---

#### **Шаг 2: Загрузка ключа в Pageant (агент PuTTY)**

1. Запустите **Pageant.exe** (находится в папке с PuTTY).
2. В системном трее появится иконка (серый квадратик) — кликните по ней.
3. Выберите **Add Key**.
4. Перейдите в папку: `C:\Users\ВашеИмя\.ssh\server-prod\`.
5. Выберите файл `id_ed25519.ppk`.
6. Введите **passphrase** — ключ загружен в агент.

> ⚠️ Pageant будет хранить ключ в памяти до перезагрузки или пока вы не закроете его.

---

#### **Шаг 3: Настройка сессии в PuTTY**

1. Откройте **PuTTY**.
2. В поле **Host Name (or IP address)** введите IP-адрес сервера.
3. Установите порт: **2222**.
4. Убедитесь, что **Connection type = SSH**.
5. В левом меню перейдите:  
   **Connection → Data**  
   → в поле **Auto-login username** введите имя пользователя (например: `deploy`).
6. Перейдите:  
   **Connection → SSH → Auth → Credentials**  
   → ничего не указывайте в поле "Private key file for authentication" — ключ будет подставлен из Pageant автоматически.
7. Вернитесь в раздел **Session**.
8. В поле **Saved Sessions** введите имя, например: `server-prod`.
9. Нажмите **Save**.

---

#### **Шаг 4: Автозагрузка Pageant с ключом (опционально, но удобно)**

1. Нажмите `Win + R`, введите: `shell:startup`, нажмите Enter.
2. Создайте ярлык на `pageant.exe`.
3. В свойствах ярлыка в поле **Объект** укажите:  
   ```
   "C:\Program Files\PuTTY\pageant.exe" "C:\Users\ВашеИмя\.ssh\server-prod\id_ed25519.ppk"
   ```
4. Сохраните.  
   → При входе в систему Pageant запустится и загрузит ключ (запросит passphrase).

---
